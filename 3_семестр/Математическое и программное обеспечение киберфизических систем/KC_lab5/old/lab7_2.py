import numpy as np
import matplotlib.pyplot as plt

x1 = float(input("Введите скорость x1 для интерфейса (Мбит/с): "))
x2 = float(input("Введите коэффициент x2 для средней длины пакета (L = x2 * 1000 байт): "))

# ---------- 2.1 ----------
len_10 = 158
t_cod_10 = 0.01
bandwidth_10 = (len_10 * 8) / t_cod_10 / 1000
print(f"2.1 Полоса передачи кодека G.711(10): {bandwidth_10:.1f} кбит/с")

# ---------- 2.2 ----------
len_30 = 318
t_cod_30 = 0.03
bandwidth_30 = (len_30 * 8) / t_cod_30 / 1000
print(f"2.2 Полоса передачи кодека G.711(30): {bandwidth_30:.1f} кбит/с")

# ---------- 2.3 ----------
service_time_10 = (len_10 * 8) / (x1 * 1e6) * 1000   # мс
print(f"2.3 Среднее время занятия пакетом (G.711(10)): {service_time_10:.3f} мс")

# ---------- 2.4 ----------
service_time_30 = (len_30 * 8) / (x1 * 1e6) * 1000   # мс
print(f"2.4 Среднее время занятия пакетом (G.711(30)): {service_time_30:.3f} мс")

# ---------- 2.5 ----------
lambda_call = 1000 / 3600  # вызовов в секунду (1000 вызовов/час)

# G.711(10)
lambda_pac_10 = lambda_call * (180 / t_cod_10)  # пакетов/с
mu_10 = (x1 * 1e6) / (len_10 * 8)               # пакетов/с
rho_10 = lambda_pac_10 / mu_10

# G.711(30)
lambda_pac_30 = lambda_call * (180 / t_cod_30)
mu_30 = (x1 * 1e6) / (len_30 * 8)
rho_30 = lambda_pac_30 / mu_30

print("\n2.5 Графики ФРВ окончания обслуживания (M/M/1):")

t_ms = np.linspace(0, 10, 1000)
t_sec = t_ms / 1000

# Первый интерфейс – G.711(10)
if rho_10 >= 1:
    print("Для G.711(10): rho >= 1, система нестабильна!")
else:
    print(f"Для G.711(10): rho = {rho_10:.3f}")
    F_10 = 1 - np.exp(-mu_10 * (1 - rho_10) * t_sec)
    plt.figure(1)
    plt.plot(t_ms, F_10, label=f'ρ = {rho_10:.3f}')
    plt.title('ФРВ окончания обслуживания (G.711(10))')
    plt.xlabel('Время, мс')
    plt.ylabel('F(t)')
    plt.legend()
    plt.grid(True)
    plt.show()

# Второй интерфейс – G.711(30)
if rho_30 >= 1:
    print("Для G.711(30): rho >= 1, система нестабильна!")
else:
    print(f"Для G.711(30): rho = {rho_30:.3f}")
    F_30 = 1 - np.exp(-mu_30 * (1 - rho_30) * t_sec)
    plt.figure(2)
    plt.plot(t_ms, F_30, label=f'ρ = {rho_30:.3f}')
    plt.title('ФРВ окончания обслуживания (G.711(30))')
    plt.xlabel('Время, мс')
    plt.ylabel('F(t)')
    plt.legend()
    plt.grid(True)
    plt.show()


# =============================================
# ========== 2.6 – НОВАЯ ЧАСТЬ ================
# =============================================

print("\n" + "="*50)
print("2.6 – Модель M/M/1 с переменной длиной пакета")
print("="*50)

delta_t = 0.020  # 20 мс в секундах
C = 10 * 1e6     # 10 Мбит/с в бит/с
L_avg = x2 * 1000 * 8  # средняя длина пакета в битах

# Интенсивность поступления пакетов: λ = i / Δt
# i – количество пакетов за интервал Δt
# Пусть i = 1 (один пакет каждые 20 мс) → λ = 1 / 0.02 = 50 пакетов/с
# Но можно обобщить: пусть i вводится пользователем
i = float(input("Введите количество пакетов i за интервал Δt = 20 мс: "))

lambda_pac = i / delta_t  # пакетов/с
mu = C / L_avg            # пакетов/с (скорость обслуживания)
rho = lambda_pac / mu     # коэффициент загрузки

print(f"\nПараметры системы:")
print(f"   Δt = {delta_t*1000:.0f} мс")
print(f"   i = {i} пакетов за Δt")
print(f"   λ = i / Δt = {lambda_pac:.2f} пакетов/с")
print(f"   L_avg = {x2} * 1000 = {x2*1000} байт = {L_avg/8:.0f} бит")
print(f"   μ = C / L_avg = {mu:.2f} пакетов/с")
print(f"   ρ = λ / μ = {rho:.3f}")

if rho >= 1:
    print("   Система нестабильна (ρ ≥ 1)!")
else:
    print("   Система устойчива (ρ < 1)")

# Функция распределения времени обслуживания (время окончания обслуживания в M/M/1)
t_sec_long = np.linspace(0, 0.1, 1000)  # до 100 мс
t_ms_long = t_sec_long * 1000

if rho < 1:
    F_x = 1 - np.exp(-(mu - lambda_pac) * t_sec_long)
    # или эквивалентно: 1 - np.exp(-(1 - rho) * mu * t_sec_long)

    plt.figure(3)
    plt.plot(t_ms_long, F_x, 'r-', linewidth=2, label=f'ρ = {rho:.3f}')
    plt.title('ФРВ времени окончания обслуживания (M/M/1, 2.6)')
    plt.xlabel('Время, мс')
    plt.ylabel('F(t)')
    plt.legend()
    plt.grid(True)
    plt.xlim(0, 100)
    plt.ylim(0, 1.05)
    plt.show()

    # Дополнительно: среднее время ожидания + обслуживания
    W = 1 / (mu - lambda_pac)  # среднее время в системе (ожидание + обслуживание)
    print(f"\n   Среднее время в системе (W): {W*1000:.3f} мс")
else:
    print("   График не строится: система неустойчива.")