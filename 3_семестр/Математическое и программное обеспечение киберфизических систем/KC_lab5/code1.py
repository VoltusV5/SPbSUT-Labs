import numpy as np
import matplotlib.pyplot as plt

# Ввод варианта
x1 = float(input("Введите x1: "))
x2_ms = float(input("Введите x2 (мс): "))

lambda_zayavok_v_sec = x1 + x2_ms          # λ = (x1 + x2) заявок/с
t_serv_sec = x2_ms / 1000.0               # среднее время обслуживания в секундах
mu = 1.0 / t_serv_sec                      # интенсивность обслуживания
a = lambda_zayavok_v_sec / mu               # ρ = λ/μ

print(f"\nλ = {x1} + {x2_ms} = {lambda_zayavok_v_sec:.3f} заявок/с")
print(f"Среднее время обслуживания = {x2_ms} мс → μ = {mu:.3f} заявок/с")
print(f"Коэффициент загрузки ρ = {a:.4f}")

if a >= 1:
    print("\nСИСТЕМА НЕСТАБИЛЬНА (ρ ≥ 1) — очереди растут бесконечно")
    print("Графики не строятся")
    exit()

print("Система стабильна (ρ < 1)\n")

# =============================================================================
# 2.1 Только M/M/1 (экспоненциальное обслуживание)
# =============================================================================
print("2.1 Экспоненциальное время обслуживания (M/M/1):")

P0 = 1 - a                                              # вероятность немедленного обслуживания
tw_mm1 = a / (mu * (1 - a)) * 1000                     # мс
P_Q_exactly_3 = (1 - a) * (a ** 4)                         # P(Q = 3) = P(n = 4)
# Если преподаватель имеет в виду P(Q ≥ 3) = a⁴ — раскомментируйте строку ниже
# P_Q_at_least_3 = a ** 4
lq_mm1 = a**2 / (1 - a)                                     # средняя длина очереди

print(f"   • Вероятность немедленного обслуживания P(0) = {P0:.6f}")
print(f"   • Среднее время ожидания начала обслуживания tw = {tw_mm1:.3f} мс")
print(f"   • Вероятность ровно 3 заявок в очереди P(Q=3) = {P_Q_exactly_3:.8f}")
# print(f"   (если нужно P(Q ≥ 3) = {P_Q_at_least_3:.8f})")
print(f"   • Средняя длина очереди Lq = {lq_mm1:.4f} заявок")

# =============================================================================
# 2.3 Средние времена для M/M/1 и M/D/1
# =============================================================================
te_mm1 = 1 / (mu * (1 - a))      # или tw_mm1/1000 + t_serv_sec, то же самое

tw_md1 = a / (2 * mu * (1 - a))   # точная формула для M/D/1
te_md1 = t_serv_sec + tw_md1

print("\n2.3 Средние времена:")
print("M/M/1 (экспоненциальное обслуживание):")
print(f"   tw = {tw_mm1:.3f} мс    te = {te_mm1*1000:.3f} мс")
print("M/D/1 (постоянное обслуживание):")
print(f"   tw = {tw_md1*1000:.3f} мс    te = {te_md1*1000:.3f} мс")

# =============================================================================
# 2.2 Графики ФРВ конца обслуживания (te)
# =============================================================================
# Адаптивный диапазон времени — чтобы весь «хвост» был виден
t_max_ms = max(50, 20 * x2_ms)   # минимум 50 мс, иначе больше варианта
t_ms = np.linspace(0, t_max_ms, 1000)
t_sec = t_ms / 1000

# M/M/1 — точная
F_mm1 = 1 - np.exp(-mu * (1 - a) * t_sec)

# M/D/1 — экспоненциальная аппроксимация с точно тем же средним te
rate_md1 = 2 * mu * (1 - a) / (2 - a)
F_md1 = 1 - np.exp(-rate_md1 * t_sec)

plt.figure(figsize=(10.5, 6.5))
plt.plot(t_ms, F_mm1, label=f'M/M/1 (эксп.) ρ = {a:.3f}', linewidth=3)
plt.plot(t_ms, F_md1, label=f'M/D/1 (детерм.) ρ = {a:.3f}', linewidth=3)
plt.title('ФРВ конца обслуживания Te(t)', fontsize=14)
plt.xlabel('Время t, мс')
plt.ylabel('F(te ≤ t)')
plt.grid(True, linestyle='--', alpha=0.7)
plt.legend(fontsize=12)
plt.tight_layout()
plt.show()

# Если нужно два отдельных графика — раскомментируйте
# plt.figure()
# plt.plot(t_ms, F_mm1, color='blue')
# plt.title('M/M/1')
# plt.show()
#
# plt.figure()
# plt.plot(t_ms, F_md1, color='green')
# plt.title('M/D/1 (эксп. аппроксимация)')
# plt.show()